---

- name: Bootstrap ansible management user
  hosts: dev-servers
  become: true
  become_user: root
  become_method: su
  gather_facts: false

  vars:
    ansible_ssh_pass: "{{ vault_ansible_ssh_pass }}"
    ansible_become_pass: "{{ vault_ansible_ssh_pass }}"

  handlers:
    - name: reboot server
      ansible.builtin.reboot:
        reboot_timeout: 300

    - name: Apply netplan and wait for connection
      when: ansible_distribution == "Ubuntu"
      block:
        - name: Apply netplan configuration
          ansible.builtin.command: netplan apply

        - name: Wait for connection to be restored (after IP change)
          ansible.builtin.wait_for_connection:
            timeout: 30
            delay: 5

  pre_tasks:

  - name: Install Sudo, Python, Curl, htop, git, wget, net-tools
    ansible.builtin.apt:
      name:
        - sudo
        - python3
        - curl
        - htop
        - wget
        - git
        - net-tools
      state: present

  - name: Gather facts after installing sudo
    ansible.builtin.setup:

  - name: install updates (Ubuntu/Debian)
    tags: always
    apt:
      upgrade: yes
      update_cache: yes
    when: ansible_distribution in ["Debian", "Ubuntu"]

  tasks:

  - name: create ansible user (ansbl-user)
    tags: always
    user:
      name: ansbl-user

  - name: add ssh key for ansbl-user
    tags: always
    authorized_key:
      user: ansbl-user
      key: "{{ lookup('file', 'files/ansible_management_user.pub') }}"

  - name:  add sudoers file for ansbl-user
    tags: always
    copy:
      src: sudoer_ansbl-user
      dest: /etc/sudoers.d/ansbl-user
      owner: root
      group:  root
      mode: 0440

  - name: Configure current DHCP address as a static IP -> Debian
    ansible.builtin.template:
      src: files/interfaces.j2
      dest: /etc/network/interfaces
      owner: root
      group: root
      mode: '0644'

  - name: Configure current DHCP address as static IP -> Ubuntu
    ansible.builtin.template:
      src: files/50-cloud-init.j2
      dest: /etc/netplan/50-cloud-init.yaml
      owner: root
      group: root
      mode: '0644'
    notify: Apply netplan and wait for connection

  - name: Add primary user to the Sudo Group
    ansible.builtin.user:
      name: "{{ ansible_user }}"
      groups: sudo
      append: yes
    become: true
    notify: reboot server
