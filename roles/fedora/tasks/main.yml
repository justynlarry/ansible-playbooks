---
- name: Update packages
  become: true
  ansible.builtin.dnf:
    name: "*"
    state: latest
    update_cache: yes

- name: Ensure required packages are installed
  become: true
  ansible.builtin.package:
    name:
      - NetworkManager
      - iproute
      - net-tools
      - python3-netaddr
    state: present

- name: Gather network facts
  ansible.builtin.setup:
    gather_subset:
      - network
  register: net_facts

- name: Set variables for DHCP-assigned IP and subnet
  ansible.builtin.set_fact:
    dhcp_ip: "{{ ansible_default_ipv4.address }}"
    dhcp_prefix: "{{ ansible_default_ipv4.netmask | ansible.utils.ipaddr('prefix') }}"
    dhcp_gateway: "{{ ansible_default_ipv4.gateway }}"

- name: Debug network vars (optional)
  ansible.builtin.debug:
    msg:
      - "DHCP IP: {{ dhcp_ip }}"
      - "Prefix: {{ dhcp_prefix }}"
      - "Gateway: {{ dhcp_gateway }}"

- name: Configure static IP using current DHCP info (via nmcli)
  community.general.nmcli:
    conn_name: "{{ ansible_default_ipv4.interface }}"
    ifname: "{{ ansible_default_ipv4.interface }}"
    state: present
    type: ethernet
    ip4: "{{ dhcp_ip }}/{{ dhcp_prefix }}"
    gw4: "{{ dhcp_gateway }}"
    dns4: ["8.8.8.8", "1.1.1.1"]
    method4: manual
  notify: 
    - Restart NetworkManager
    - reboot server
